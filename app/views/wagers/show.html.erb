<div class="mx-auto max-w-6xl px-6 py-10">
  <div
    data-privy-widget="1"
    data-variant="logout_only"
    data-privy-app-id="<%= ENV["PRIVY_APP_ID"].to_s %>"
  ></div>

  <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-12">
    <div class="lg:col-span-7 lg:col-start-2">
      <div class="rounded-xl border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-4">
          <h1 class="text-2xl font-semibold text-slate-900">Wager #<%= @wager.id %></h1>
          <div class="mt-1 font-mono text-sm text-slate-700"><%= @wager.tag_a %> vs <%= @wager.tag_b %></div>
    </div>

        <div class="grid grid-cols-1 gap-4 px-5 py-4 sm:grid-cols-2">
          <div class="rounded-lg border border-slate-200 p-4">
            <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Status</div>
            <div class="mt-2 text-lg font-semibold text-slate-900"><%= @wager.status_display %></div>
            <div class="mt-2 text-sm text-slate-700">
              Amount: <span class="font-mono"><%= @wager.amount_sol %></span> sol
    </div>
            <div class="mt-1 text-sm text-slate-700">
              Deadline: <span class="font-mono"><%= @wager.deadline_at&.utc&.iso8601 %></span>
  </div>

            <% can_accept = current_user.present? && current_user.id != @wager.creator_id && @wager.joiner_id.nil? && !@wager.status_expired? && !@wager.status_refunded? && !@wager.status_settled? && !@wager.status_failed? && @wager.deadline_at > Time.current %>
            <% if can_accept %>
              <div class="mt-3">
                <%= button_to "Accept wager",
                  accept_wager_path(@wager),
                  method: :post,
                  class: "inline-flex cursor-pointer items-center rounded-lg bg-black px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2 active:bg-slate-950" %>
              </div>
            <% end %>
    </div>

          <div class="rounded-lg border border-slate-200 p-4">
            <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Resolution</div>
            <div class="mt-2 text-sm text-slate-700">
              Battle time: <span class="font-mono"><%= @wager.battle_time&.utc&.iso8601 || "-" %></span>
            </div>
            <div class="mt-1 text-sm text-slate-700">
              Winner tag: <span class="font-mono"><%= @wager.winner_tag || "-" %></span>
            </div>
            <div class="mt-1 text-sm text-slate-700">
              Fingerprint: <span class="font-mono break-all"><%= @wager.battle_fingerprint || "-" %></span>
            </div>
    </div>
  </div>

        <% 
          # Determine if current user is the winner
          is_winner = false
          if current_user.present? && @wager.winner_tag.present?
            user_tag = current_user.clash_royale_tag.to_s.strip.upcase
            winner_tag = @wager.winner_tag.to_s.strip.upcase
            is_winner = user_tag == winner_tag
          end
        %>

        <% if is_winner && (@wager.status_resolved? || @wager.status_settled?) %>
          <div
            id="winner-celebration-root"
            data-privy-app-id="<%= ENV["PRIVY_APP_ID"].to_s %>"
            data-wager-id="<%= @wager.id %>"
            data-wager-status="<%= @wager.status %>"
            data-winner-tag="<%= @wager.winner_tag %>"
            data-is-winner="<%= is_winner %>"
            data-amount-sol="<%= @wager.amount_sol %>"
            data-solana-rpc-url="<%= ENV.fetch("SOLANA_RPC_URL", "https://api.devnet.solana.com") %>"
          ></div>
        <% end %>

        <% if @wager.status_settled? %>
          <div class="border-t border-slate-200 px-5 py-4">
            <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Decks</div>

            <% if @wager.respond_to?(:battle_data) && @wager.battle_data.present? %>
              <% a = @wager.battle_data["tag_a"] || {} %>
              <% b = @wager.battle_data["tag_b"] || {} %>
              <% mode_name = @wager.battle_data.dig("gameMode", "name").to_s.presence || "1v1 Battle" %>
              <% a_crowns = (@wager.battle_data["tag_a_crowns"].presence || a["crowns"]).to_i %>
              <% b_crowns = (@wager.battle_data["tag_b_crowns"].presence || b["crowns"]).to_i %>
              <% winner_tag_norm = @wager.winner_tag.to_s.strip.upcase %>
              <% a_tag_norm = (a["tag"].presence || @wager.tag_a).to_s.strip.upcase %>
              <% b_tag_norm = (b["tag"].presence || @wager.tag_b).to_s.strip.upcase %>

              <div class="mt-3 flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-900"><%= mode_name %></div>
                <div class="text-sm font-semibold text-slate-900"><%= a_crowns %> - <%= b_crowns %></div>
              </div>

              <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div class="rounded-lg border border-slate-200 bg-white p-4">
                  <div class="flex items-baseline justify-between">
                    <div>
                      <div class="flex items-center gap-2">
                        <% if winner_tag_norm.present? && winner_tag_norm == a_tag_norm %>
                          <span class="rounded-md bg-emerald-600 px-2 py-0.5 text-[11px] font-semibold text-white">Victory</span>
                        <% elsif winner_tag_norm.present? %>
                          <span class="rounded-md bg-slate-700 px-2 py-0.5 text-[11px] font-semibold text-white">Defeat</span>
                        <% end %>
                        <div class="text-sm font-semibold text-slate-900"><%= a["name"].presence || @wager.tag_a %></div>
                      </div>
                      <% clan_name = a.dig("clan", "name").to_s.presence %>
                      <% if clan_name.present? %>
                        <div class="mt-1 text-xs text-slate-500"><%= clan_name %></div>
                      <% end %>
                    </div>
                    <div class="text-right">
                      <% if a["startingTrophies"].present? %>
                        <div class="rounded-md bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-800"><%= a["startingTrophies"] %></div>
                      <% end %>
                      <% if a["trophyChange"].present? %>
                        <% tc = a["trophyChange"].to_i %>
                        <div class="mt-1 text-[11px] font-semibold <%= tc >= 0 ? "text-emerald-700" : "text-rose-700" %>">
                          <%= tc >= 0 ? "+#{tc}" : tc %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                  <div class="mt-3 grid grid-cols-4 gap-2">
                    <% (a["deck"] || []).each do |card| %>
                      <% icon = cr_card_icon_url(card["id"]) %>
                      <div class="overflow-hidden rounded-lg border border-slate-200 bg-slate-50">
                        <% if icon.present? %>
                          <%= image_tag icon, alt: (card["name"] || "Card"), class: "h-20 w-full object-cover", loading: "lazy" %>
                        <% else %>
                          <div class="flex h-20 items-center justify-center px-1 text-center text-[10px] font-semibold text-slate-700"><%= card["name"] || card["id"] %></div>
                        <% end %>
                        <div class="border-t border-slate-200 bg-white py-1 text-center text-[10px] font-semibold text-slate-700">
                          Lvl <%= card["level"] || "?" %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="rounded-lg border border-slate-200 bg-white p-4">
                  <div class="flex items-baseline justify-between">
                    <div>
                      <div class="flex items-center gap-2">
                        <% if winner_tag_norm.present? && winner_tag_norm == b_tag_norm %>
                          <span class="rounded-md bg-emerald-600 px-2 py-0.5 text-[11px] font-semibold text-white">Victory</span>
                        <% elsif winner_tag_norm.present? %>
                          <span class="rounded-md bg-slate-700 px-2 py-0.5 text-[11px] font-semibold text-white">Defeat</span>
                        <% end %>
                        <div class="text-sm font-semibold text-slate-900"><%= b["name"].presence || @wager.tag_b %></div>
                      </div>
                      <% clan_name = b.dig("clan", "name").to_s.presence %>
                      <% if clan_name.present? %>
                        <div class="mt-1 text-xs text-slate-500"><%= clan_name %></div>
                      <% end %>
                    </div>
                    <div class="text-right">
                      <% if b["startingTrophies"].present? %>
                        <div class="rounded-md bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-800"><%= b["startingTrophies"] %></div>
                      <% end %>
                      <% if b["trophyChange"].present? %>
                        <% tc = b["trophyChange"].to_i %>
                        <div class="mt-1 text-[11px] font-semibold <%= tc >= 0 ? "text-emerald-700" : "text-rose-700" %>">
                          <%= tc >= 0 ? "+#{tc}" : tc %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                  <div class="mt-3 grid grid-cols-4 gap-2">
                    <% (b["deck"] || []).each do |card| %>
                      <% icon = cr_card_icon_url(card["id"]) %>
                      <div class="overflow-hidden rounded-lg border border-slate-200 bg-slate-50">
                        <% if icon.present? %>
                          <%= image_tag icon, alt: (card["name"] || "Card"), class: "h-20 w-full object-cover", loading: "lazy" %>
                        <% else %>
                          <div class="flex h-20 items-center justify-center px-1 text-center text-[10px] font-semibold text-slate-700"><%= card["name"] || card["id"] %></div>
                        <% end %>
                        <div class="border-t border-slate-200 bg-white py-1 text-center text-[10px] font-semibold text-slate-700">
                          Lvl <%= card["level"] || "?" %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="mt-2 text-sm text-slate-600">Deck unavailable (settled before deck tracking).</div>
            <% end %>
          </div>
        <% end %>

        <div class="border-t border-slate-200 px-5 py-4">
          <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Escrow</div>
          <div class="mt-3">
      <div
        id="wager-escrow-root"
        data-privy-app-id="<%= ENV["PRIVY_APP_ID"].to_s %>"
        data-wager-id="<%= @wager.id %>"
        data-amount-lamports="<%= @wager.amount_lamports %>"
        data-deadline-unix-timestamp="<%= @wager.deadline_at.to_i %>"
        data-status="<%= @wager.status %>"
        data-is-creator="<%= current_user.present? && current_user.id == @wager.creator_id %>"
        data-is-joiner="<%= current_user.present? && current_user.id == @wager.joiner_id %>"
        data-has-joiner="<%= @wager.joiner_id.present? %>"
        data-solana-cluster="<%= ENV.fetch("SOLANA_CLUSTER", "devnet") %>"
        data-solana-rpc-url="<%= ENV.fetch("SOLANA_RPC_URL", "https://api.devnet.solana.com") %>"
              data-escrow-program-id="<%= Solana::Escrow::ProgramId.call %>"
              data-oracle-pubkey="<%= Solana::Escrow::OraclePubkey.call %>"
            ></div>
          </div>
        </div>

        <% if current_user.present? && current_user.id == @wager.creator_id && @wager.joiner_id.nil? %>
          <div class="border-t border-slate-200 px-5 py-4">
            <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Invite link</div>

            <% invite_url = flash[:invite_url].presence || (@active_invite.present? ? wager_invite_url(@active_invite.token) : nil) %>
            
            <% if flash[:invite_url].present? %>
              <div class="mt-2 text-sm text-slate-700">
                <span class="font-semibold">New link:</span>
                <span class="ml-2 font-mono break-all" id="invite-link-text"><%= flash[:invite_url] %></span>
              </div>
            <% elsif @active_invite.present? %>
              <div class="mt-2 text-sm text-slate-700">
                <span class="font-semibold">Current link:</span>
                <span class="ml-2 font-mono break-all" id="invite-link-text"><%= wager_invite_url(@active_invite.token) %></span>
              </div>
            <% end %>

            <div class="mt-3 flex items-center gap-2">
              <%= button_to "Generate invite link",
                invite_wager_path(@wager),
                method: :post,
                class: "inline-flex cursor-pointer items-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm transition-colors hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2 active:bg-slate-100" %>
              
              <% if invite_url.present? %>
                <button
                  type="button"
                  onclick="copyInviteLink()"
                  class="inline-flex cursor-pointer items-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm transition-colors hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2 active:bg-slate-100"
                >
                  Copy link
                </button>
              <% end %>
            </div>

            <script>
              function copyInviteLink() {
                const linkText = document.getElementById('invite-link-text')?.textContent?.trim();
                if (!linkText) return;
                
                navigator.clipboard.writeText(linkText).then(() => {
                  window.dispatchEvent(new CustomEvent('royale:toast', {
                    detail: { message: 'Invite link copied', tone: 'success' }
                  }));
                }).catch(() => {
                  window.dispatchEvent(new CustomEvent('royale:toast', {
                    detail: { message: 'Failed to copy link', tone: 'error' }
                  }));
                });
              }

              // Auto-copy when a new invite link is created
              <% if flash[:invite_url].present? %>
                document.addEventListener('DOMContentLoaded', () => {
                  setTimeout(() => {
                    copyInviteLink();
                  }, 100);
                });
              <% end %>
            </script>
          </div>
        <% end %>
      </div>
    </div>

    <div class="lg:col-span-4 lg:col-start-9">
      <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="text-xs font-semibold uppercase tracking-widest text-slate-500">Wallet</div>
        <div class="mt-4">
          <div
            data-privy-widget="1"
            data-variant="fund_only"
            data-privy-app-id="<%= ENV["PRIVY_APP_ID"].to_s %>"
            data-solana-cluster="<%= ENV.fetch("SOLANA_CLUSTER", "devnet") %>"
            data-solana-rpc-url="<%= ENV.fetch("SOLANA_RPC_URL", "https://api.devnet.solana.com") %>"
      ></div>
        </div>
      </div>
    </div>
  </div>
</div>


